<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universal AI Proxy</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body{background:#000;color:#fff;margin:0;height:100dvh;display:grid;place-items:center;font-family:monospace}
    .card{width:92vmin;max-width:800px;background:#000;border:3px solid rgba(250,204,21,.3);border-radius:16px}
    .header{background:#000;border-bottom:2px solid #facc15;padding:20px;text-align:center;font-size:28px;font-weight:300}
    .content{padding:20px;height:50dvh;overflow-y:auto}
    .input-group{padding:20px;position:relative}
    textarea{width:100%;height:140px;background:rgba(0,0,0,.4);border:2px solid #facc15;border-radius:32px;color:#fff;padding:20px 80px 20px 20px;font-size:18px;resize:none;outline:none;box-sizing:border-box}
    button{position:absolute;right:30px;bottom:30px;width:55px;height:55px;background:#facc15;color:#000;border:none;border-radius:50%;font-size:32px;font-weight:900;box-shadow:0 4px 20px rgba(250,204,21,.5);display:grid;place-items:center;cursor:pointer}
    button:hover{transform:scale(1.1);box-shadow:0 6px 30px rgba(250,204,21,.7)}
    button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .thinking{text-align:center;padding:60px;font-size:48px;animation:p 2s infinite;color:#facc15}
    @keyframes p{0%,100%{opacity:.4}50%{opacity:1}}
    .workflow-step{margin:10px 0;padding:10px;background:rgba(250,204,21,.1);border-radius:8px;font-size:14px}
    .workflow-step.success{background:rgba(34,197,94,.2);border-left:4px solid #22c55e}
    .workflow-step.error{background:rgba(239,68,68,.2);border-left:4px solid #ef4444}
    .workflow-step.pending{background:rgba(59,130,246,.2);border-left:4px solid #3b82f6}
    .preset-selector{padding:10px;margin-bottom:10px;display:flex;gap:15px;align-items:center;flex-wrap:wrap}
    .preset-selector select{background:#000;color:#fff;border:1px solid #facc15;padding:5px;border-radius:4px}
    .variants{display:flex;gap:10px}
    .variant-label{display:flex;align-items:center;gap:5px;font-size:12px}
    .variant-label input[type="checkbox"]{accent-color:#facc15}
    .thinking-block{background:rgba(59,130,246,.1);border-left:4px solid #3b82f6;padding:10px;margin:10px 0;border-radius:4px;font-style:italic}
    .settings-row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
    .settings-row label{color:#facc15;font-size:14px;min-width:80px}
    .settings-row input{background:#000;color:#fff;border:1px solid #facc15;padding:5px;border-radius:4px;flex:1;min-width:200px}
    .settings-row button{position:static;width:auto;height:auto;padding:5px 15px;font-size:14px;border-radius:4px}
    #error-display{color:#ef4444;padding:20px;text-align:center;display:none}
    .response-content{background:rgba(250,204,21,.05);padding:20px;border-radius:12px;border:1px solid rgba(250,204,21,.2);margin:20px 0}
    .quick-actions{padding:15px;background:rgba(59,130,246,.1);border-radius:8px;font-size:12px;margin-top:20px}
    .quick-actions button{position:static;width:auto;height:auto;padding:5px 10px;font-size:12px;border-radius:4px;margin:5px;cursor:pointer;border:none}
    .status-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:10px}
    .status-badge.ok{background:rgba(34,197,94,.2);color:#22c55e}
    .status-badge.error{background:rgba(239,68,68,.2);color:#ef4444}
    .debug-info{background:rgba(0,0,0,.5);padding:10px;border-radius:4px;font-size:11px;color:#666;margin-top:10px}
    .admin-section{margin-top:20px;padding:15px;background:rgba(139,92,246,.1);border-radius:8px;border-left:4px solid #8b5cf6}
    .admin-section h3{color:#8b5cf6;margin:0 0 10px 0;font-size:14px}
    .admin-row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .admin-row input{background:#1a1a1a;color:#fff;border:1px solid #8b5cf6;padding:8px;border-radius:4px}
    .admin-row input[type="text"]{flex:1}
    .admin-row input[type="password"]{flex:0.5}
    .admin-row button{position:static;width:auto;height:auto;padding:8px 15px;font-size:12px;border-radius:4px;background:#8b5cf6;color:#fff}
    .knowledge-list{margin-top:10px;max-height:200px;overflow-y:auto}
    .knowledge-item{background:rgba(0,0,0,.5);padding:10px;margin:5px 0;border-radius:4px;font-size:11px}
    .knowledge-item .title{color:#8b5cf6;font-weight:bold;margin-bottom:5px}
    .knowledge-item .actions{margin-top:5px}
    .knowledge-item .actions button{padding:2px 8px;font-size:10px;margin-right:5px}
  </style>
</head>
<body>
<div class="card">
  <div class="header">
    Universal AI Proxy
    <span id="statusBadge" class="status-badge"></span>
  </div>
  <div class="content" id="c">
    <div style="color:#94a3b8;text-align:center;padding:40px;">
      <div style="font-size:18px;margin-bottom:20px;">Ready to process</div>
      <div style="font-size:12px;">
        Press Enter or click the button to send your query.
      </div>
      <div class="debug-info" id="debugInfo"></div>
    </div>
  </div>
  <div id="error-display"></div>
  <div class="input-group">
    <div class="preset-selector">
      <label>Preset:
        <select id="basePreset">
          <option value="truth-engine">truth-engine</option>
          <option value="coding">coding</option>
          <option value="research">research</option>
          <option value="creative">creative</option>
          <option value="default">default</option>
        </select>
      </label>
      <div class="variants">
        <label class="variant-label">
          <input type="checkbox" id="variantOnline"> :online
        </label>
        <label class="variant-label">
          <input type="checkbox" id="variantExtended"> :extended
        </label>
      </div>
    </div>
    <div class="settings-row">
      <label>Session ID:</label>
      <input type="text" id="sessionId" readonly style="flex:0.5">
      <button onclick="resetSession()">New Session</button>
    </div>
    <textarea id="i" placeholder="Ask anything..."></textarea>
    <button id="sendBtn" onclick="go()">‚èé</button>
  </div>
</div>

<script>
// CORRECT WORKER URL - UPDATED
const WORKER_URL = 'https://orproxy.ai-n.workers.dev/api/generate';
const ADMIN_API_URL = 'https://orproxy.ai-n.workers.dev/api/admin';

class AIProxy {
  constructor() {
    this.sessionId = this.getOrCreateSessionId();
    this.conversationHistory = this.loadHistory();
  }

  getOrCreateSessionId() {
    let sessionId = localStorage.getItem('ai-session-id');
    if (!sessionId) {
      sessionId = 'sess-' + Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 5);
      localStorage.setItem('ai-session-id', sessionId);
    }
    return sessionId;
  }

  loadHistory() {
    try {
      return JSON.parse(localStorage.getItem('conversation-history') || '[]');
    } catch {
      return [];
    }
  }

  saveHistory() {
    try {
      localStorage.setItem('conversation-history', JSON.stringify(this.conversationHistory));
    } catch(e) {
      console.log('Failed to save history');
    }
  }

  addToHistory(userPrompt, assistantResponse) {
    this.conversationHistory.push({
      user: userPrompt,
      assistant: assistantResponse,
      timestamp: Date.now()
    });
    
    if (this.conversationHistory.length > 50) {
      this.conversationHistory = this.conversationHistory.slice(-50);
    }
    
    this.saveHistory();
  }

  getLastExchange() {
    return this.conversationHistory[this.conversationHistory.length - 1] || null;
  }

  async sendRequest(prompt, preset) {
    const requestBody = {
      prompt: prompt,
      preset: preset,
      stream: true,
      tools: [],
      context_id: this.sessionId
    };

    console.log('=== WORKER REQUEST ===');
    console.log('URL:', WORKER_URL);
    console.log('Request:', JSON.stringify(requestBody, null, 2));

    const response = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });

    console.log('=== WORKER RESPONSE ===');
    console.log('Status:', response.status);
    console.log('Status Text:', response.statusText);
    console.log('Headers:', Object.fromEntries(response.headers.entries()));

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Error body:', errorText);
      throw new Error(`API error ${response.status}: ${errorText.substring(0, 300)}`);
    }

    return response.body;
  }

  // Process OpenRouter streaming format (OpenAI-compatible)
  async *processOpenRouterStream(stream) {
    const reader = stream.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let chunkCount = 0;

    try {
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = line.slice(6);
            
            // Skip [DONE] marker
            if (data === '[DONE]') {
              console.log('Stream complete (DONE)');
              return;
            }

            try {
              const parsed = JSON.parse(data);
              chunkCount++;
              
              // Debug first chunk
              if (chunkCount === 1) {
                console.log('First chunk:', JSON.stringify(parsed, null, 2));
              }
              
              // OpenRouter/OpenAI streaming format
              if (parsed.choices && parsed.choices.length > 0) {
                const delta = parsed.choices[0].delta;
                
                if (delta && delta.content) {
                  yield delta.content;
                }
                
                // Check for completion
                if (parsed.choices[0].finish_reason) {
                  console.log(`Stream complete after ${chunkCount} chunks, finish_reason: ${parsed.choices[0].finish_reason}`);
                  return;
                }
              }
              
            } catch (e) {
              console.log('Parse error for chunk:', line.substring(0, 100));
            }
          }
        }
      }
    } catch (error) {
      console.error('Stream error:', error);
      throw error;
    }
  }
}

const aiProxy = new AIProxy();

// Initialize
document.getElementById('sessionId').value = aiProxy.sessionId;

// Show debug info
document.getElementById('debugInfo').innerHTML = `
  Worker URL: ${WORKER_URL}<br>
  Session: ${aiProxy.sessionId.substring(0, 15)}...
`;

// Load saved input
window.addEventListener('load', () => {
  const draft = localStorage.getItem('ai-input-draft');
  if (draft) {
    document.getElementById('i').value = draft;
  }
  
  // Check for query param
  const q = new URLSearchParams(location.search).get('q');
  if (q) { 
    document.getElementById('i').value = q.replace(/\s+/g, ' '); 
    go(); 
  }
});

function buildPresetString() {
  const base = document.getElementById('basePreset').value;
  const variants = [];
  
  if (document.getElementById('variantOnline').checked) variants.push('online');
  if (document.getElementById('variantExtended').checked) variants.push('extended');
  
  return variants.length > 0 ? `${base}:${variants.join(':')}` : base;
}

function showError(message, type = 'error') {
  const errorDiv = document.getElementById('error-display');
  errorDiv.style.display = 'block';
  errorDiv.style.color = type === 'success' ? '#22c55e' : '#ef4444';
  errorDiv.textContent = message;
  
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

function resetSession() {
  if (confirm('Start a new session? Current session ID will be lost.')) {
    localStorage.removeItem('ai-session-id');
    aiProxy.sessionId = aiProxy.getOrCreateSessionId();
    document.getElementById('sessionId').value = aiProxy.sessionId;
    showError('New session created', 'success');
  }
}

async function go() {
  let q = document.getElementById('i').value.trim();
  
  if (!q) return;
  
  // Check for follow-up shortcut
  if (q === '...' || q === 'continue') {
    const last = aiProxy.getLastExchange();
    if (last) {
      const last200 = last.assistant.substring(Math.max(0, last.assistant.length - 200));
      q = `Continue from where we left off: ${last200}`;
    } else {
      showError('No previous conversation to continue');
      return;
    }
  }
  
  document.getElementById('i').value = '';
  localStorage.removeItem('ai-input-draft');
  
  const preset = buildPresetString();
  const sendBtn = document.getElementById('sendBtn');
  
  // Display workflow steps
  let workflowLog = '';
  const logStep = (step, status, message) => {
    workflowLog += `<div class="workflow-step ${status}"><strong>${step}:</strong> ${message}</div>`;
    document.getElementById('c').innerHTML = workflowLog + '<div class="thinking">processing...</div>';
    document.getElementById('c').scrollTop = document.getElementById('c').scrollHeight;
  };

  logStep('Session', 'pending', `ID: ${aiProxy.sessionId.substring(0, 12)}...`);
  logStep('Preset', 'pending', `Model: ${preset}`);
  logStep('Worker', 'pending', `URL: ${WORKER_URL.substring(0, 35)}...`);

  sendBtn.disabled = true;

  try {
    logStep('Worker', 'success', 'Connecting...');
    
    const stream = await aiProxy.sendRequest(q, preset);
    
    logStep('Worker', 'success', 'Streaming response...');
    
    workflowLog += `<div class="workflow-step success"><strong>Receiving:</strong> Tokens streaming...</div>`;
    document.getElementById('c').innerHTML = workflowLog + '<div id="response"></div>';
    
    const responseDiv = document.getElementById('response');
    responseDiv.innerHTML = '<div class="thinking">AI is thinking...</div>';
    
    let fullAnswer = '';

    // Process the stream
    const streamProcessor = aiProxy.processOpenRouterStream(stream);
    
    for await (const chunk of streamProcessor) {
      fullAnswer += chunk;
      
      // Render with marked
      responseDiv.innerHTML = marked.parse(fullAnswer);
      document.getElementById('c').scrollTop = document.getElementById('c').scrollHeight;
    }

    // Save to history
    aiProxy.addToHistory(q, fullAnswer);
    
    // Show completion with admin section
    document.getElementById('c').innerHTML = `
      <div style="margin-bottom: 20px; padding: 15px; background: rgba(34,197,94,.1); border-radius: 8px; border-left: 4px solid #22c55e;">
        <strong>Complete</strong> (Session: ${aiProxy.sessionId.substring(0, 12)}..., Preset: ${preset})
      </div>
      <div class="response-content">
        ${marked.parse(fullAnswer)}
      </div>
      <div class="quick-actions">
        <strong>Quick actions:</strong><br>
        <button onclick="continueLast()" style="background: #3b82f6; color: white;">Continue last</button>
        <button onclick="clearHistory()" style="background: #ef4444; color: white;">Clear history</button>
        <button onclick="copyResponse()" style="background: #facc15; color: black;">Copy</button>
      </div>
      <div class="admin-section">
        <h3>Admin: Master Knowledge Base</h3>
        <div class="admin-row">
          <input type="password" id="adminSecret" placeholder="Admin Secret">
          <button onclick="loadKnowledge()">Load Knowledge</button>
        </div>
        <div class="admin-row">
          <input type="text" id="knowledgeTitle" placeholder="Title">
          <input type="text" id="knowledgeContent" placeholder="Content">
          <button onclick="addKnowledge()">Add</button>
        </div>
        <div id="knowledgeList" class="knowledge-list"></div>
      </div>
    `;
    
  } catch(error) {
    logStep('Error', 'error', error.message);
    document.getElementById('c').innerHTML += `<div style="color: #ef4444; margin-top: 20px;">Error: ${error.message}</div>`;
    
    // Debug info
    document.getElementById('c').innerHTML += `
      <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,.5); border-radius: 8px; font-size: 11px; color: #666;">
        <strong>Debug Info:</strong><br>
        Worker URL: ${WORKER_URL}<br>
        Session: ${aiProxy.sessionId}<br>
        Preset: ${preset}<br>
        <br>
        <strong>Check these:</strong><br>
        1. Worker is deployed properly<br>
        2. OPENROUTER_API_KEY is set<br>
        3. ADMIN_SECRET is set for admin features
      </div>
    `;
  } finally {
    sendBtn.disabled = false;
  }
}

function continueLast() {
  document.getElementById('i').value = '...';
  go();
}

function clearHistory() {
  if (confirm('Clear conversation history?')) {
    localStorage.removeItem('conversation-history');
    localStorage.removeItem('ai-session-id');
    aiProxy.sessionId = aiProxy.getOrCreateSessionId();
    aiProxy.conversationHistory = [];
    document.getElementById('sessionId').value = aiProxy.sessionId;
    document.getElementById('c').innerHTML = '<div style="color: #22c55e;">History cleared. New session started.</div>';
  }
}

function copyResponse() {
  const responseDiv = document.querySelector('.response-content');
  if (responseDiv) {
    navigator.clipboard.writeText(responseDiv.textContent).then(() => {
      showError('Response copied', 'success');
    });
  }
}

// Admin Functions for Master Knowledge Base
async function loadKnowledge() {
  const secret = document.getElementById('adminSecret').value;
  if (!secret) {
    showError('Please enter admin secret', 'error');
    return;
  }

  try {
    const response = await fetch(`${ADMIN_API_URL}/knowledge`, {
      headers: { 'X-Admin-Secret': secret }
    });

    if (!response.ok) {
      throw new Error('Unauthorized');
    }

    const data = await response.json();
    const listDiv = document.getElementById('knowledgeList');
    
    if (data.entries.length === 0) {
      listDiv.innerHTML = '<div style="color:#666;">No knowledge entries yet</div>';
      return;
    }

    listDiv.innerHTML = data.entries.map(e => `
      <div class="knowledge-item">
        <div class="title">${e.title}</div>
        <div>${e.content.substring(0, 100)}...</div>
        <div class="actions">
          <button onclick="editKnowledge('${e.id}')" style="background:#3b82f6;color:#fff;">Edit</button>
          <button onclick="deleteKnowledge('${e.id}')" style="background:#ef4444;color:#fff;">Delete</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    showError('Failed to load knowledge: ' + error.message, 'error');
  }
}

async function addKnowledge() {
  const secret = document.getElementById('adminSecret').value;
  const title = document.getElementById('knowledgeTitle').value;
  const content = document.getElementById('knowledgeContent').value;

  if (!secret || !title || !content) {
    showError('All fields required', 'error');
    return;
  }

  try {
    const response = await fetch(`${ADMIN_API_URL}/knowledge`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Secret': secret
      },
      body: JSON.stringify({ title, content })
    });

    if (!response.ok) {
      throw new Error('Unauthorized or failed');
    }

    showError('Knowledge added', 'success');
    document.getElementById('knowledgeTitle').value = '';
    document.getElementById('knowledgeContent').value = '';
    loadKnowledge();
  } catch (error) {
    showError('Failed to add knowledge: ' + error.message, 'error');
  }
}

async function editKnowledge(id) {
  const secret = document.getElementById('adminSecret').value;
  const content = prompt('Edit content:');
  
  if (content === null) return;

  try {
    const response = await fetch(`${ADMIN_API_URL}/knowledge/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Secret': secret
      },
      body: JSON.stringify({ content })
    });

    if (!response.ok) {
      throw new Error('Failed to update');
    }

    showError('Knowledge updated', 'success');
    loadKnowledge();
  } catch (error) {
    showError('Failed to edit: ' + error.message, 'error');
  }
}

async function deleteKnowledge(id) {
  if (!confirm('Delete this knowledge entry?')) return;

  const secret = document.getElementById('adminSecret').value;

  try {
    const response = await fetch(`${ADMIN_API_URL}/knowledge/${id}`, {
      method: 'DELETE',
      headers: { 'X-Admin-Secret': secret }
    });

    if (!response.ok) {
      throw new Error('Failed to delete');
    }

    showError('Knowledge deleted', 'success');
    loadKnowledge();
  } catch (error) {
    showError('Failed to delete: ' + error.message, 'error');
  }
}

// Keyboard shortcuts
document.getElementById('i').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    go();
  }
});

// Auto-save input
document.getElementById('i').addEventListener('input', () => {
  localStorage.setItem('ai-input-draft', document.getElementById('i').value);
});
</script>
</body>
</html>
