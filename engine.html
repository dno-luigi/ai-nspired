<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Truth Engine | ai-n Forge</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --gold: #facc15; --bg: #0a0a15; }
        .matrix { --gold: #00ff41; --bg: #000; background:#000 !important; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui,-apple-system,sans-serif; }
        body { overflow:hidden; height:100dvh; background:radial-gradient(ellipse at top,#1e1b4b 0%,var(--bg) 70%); color:white; transition:all .5s; }
        #canvas { width:100vw; height:100dvh; position:relative; }

        .yard { position:absolute; inset:0; margin:auto; width:90vmin; height:90vmin;
                border:4px solid rgba(250,204,21,0.25); border-radius:32px; box-shadow:0 0 100px rgba(250,204,21,0.3); pointer-events:none; backdrop-filter:blur(4px); }
        .matrix .yard { border-color:rgba(0,255,65,0.4); box-shadow:0 0 100px rgba(0,255,65,0.4); }

        .card { position:absolute; width:42vmin; height:42vmin; min-width:300px; min-height:300px; 
                background:rgba(255,255,255,0.06); backdrop-filter:blur(60px); border-radius:32px; overflow:hidden;
                box-shadow:0 20px 60px rgba(0,0,0,0.6), 0 0 80px rgba(250,204,21,0.15); border:1px solid rgba(250,204,21,0.2);
                transition:all .4s cubic-bezier(0.16,1,0.3,1); }
        .card.dragging { transform:scale(1.08); z-index:9999; box-shadow:0 0 120px rgba(250,204,21,0.5); }
        .card.fullscreen { position:fixed !important; top:0 !important; left:0 !important; width:100vw !important; height:100dvh !important;
                           border-radius:0 !important; z-index:10000; border:none; }

        .header { height:80px; padding:20px 140px 20px 20px; display:flex; align-items:center; position:relative; cursor:grab; }
        .header:active { cursor:grabbing; }
        .title { font-weight:900; font-size:20px; background:linear-gradient(90deg,var(--gold),#fbbf24); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

        .topbtns { position:absolute; top:12px; right:12px; display:flex; gap:12px; z-index:20; }
        .topbtn { width:48px; height:48px; background:rgba(255,255,255,0.1); backdrop-filter:blur(20px); border-radius:50%; 
                  display:grid; place-items:center; font-size:20px; cursor:pointer; }

        .content { height:calc(100% - 140px); padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:16px; }
        .message { padding:12px 16px; border-radius:16px; max-width:85%; }
        .user { align-self:flex-end; background:rgba(250,204,21,0.2); border:1px solid rgba(250,204,21,0.4); }
        .ai { align-self:flex-start; background:rgba(255,255,255,0.08); }

        .inputbar { height:60px; padding:10px 20px; background:rgba(0,0,0,0.4); border-top:1px solid rgba(250,204,21,0.2); display:flex; gap:12px; align-items:end; }
        .input { flex:1; background:rgba(255,255,255,0.08); border:1px solid rgba(250,204,21,0.4); border-radius:16px; padding:12px; color:white; font-size:15px; outline:none; resize:none; min-height:44px; max-height:120px; }
        .send { width:48px; height:48px; background:var(--gold); color:#000; border:none; border-radius:50%; font-size:20px; font-weight:900; cursor:pointer; }

        .forgebar { position:fixed; top:16px; left:50%; transform:translateX(-50%); background:rgba(15,15,25,0.95); backdrop-filter:blur(40px);
                    padding:12px 28px; border-radius:50px; border:2px solid rgba(250,204,21,0.3); box-shadow:0 20px 60px rgba(0,0,0,0.6); z-index:5000; display:flex; gap:20px; align-items:center; }
        .fbtn { width:64px; height:64px; background:rgba(250,204,21,0.2); border:2px solid var(--gold); border-radius:50%; color:var(--gold); font-size:32px; display:grid; place-items:center; box-shadow:0 0 40px rgba(250,204,21,0.3); cursor:pointer; }
    </style>
</head>
<body>
    <div id="canvas"><div class="yard"></div></div>

    <div class="forgebar">
        <button class="fbtn" onclick="forge.create()">‚ö°</button>
        <button class="fbtn" onclick="document.body.classList.toggle('matrix')">üëÅ</button>
        <button class="fbtn" onclick="forge.clear()">üóë</button>
        <span style="color:#facc15; font-weight:900; font-size:18px;" id="count">0/16</span>
    </div>

<script>
class Forge {
    constructor() {
        this.nodes = JSON.parse(localStorage.getItem('truthyard16')||'[]');
        this.canvas = document.getElementById('canvas');

        const q = new URLSearchParams(location.search).get('q');
        if (q) {
            this.create(decodeURIComponent(q.replace(/\+/g, ' ')));
        } else if (this.nodes.length === 0) {
            this.create();
        }
        this.restore();
    }

    create(autoQuery = null) {
        if (this.nodes.length >= 16) return;
        const node = {id:Date.now(), x:25, y:25, messages:[]};
        this.nodes.push(node);
        this.render(node);
        this.save();

        if (autoQuery || this.nodes.length === 1) {
            setTimeout(() => node.el.classList.add('fullscreen'), 100);
        }
        if (autoQuery) {
            setTimeout(() => this.ask(node.id, autoQuery), 600);
        }
    }

    render(node) {
        const el = document.createElement('div');
        el.className = 'card';
        el.style.left = node.x + 'vmin';
        el.style.top = node.y + 'vmin';
        el.innerHTML = `
            <div class="header">
                <div class="title">TRUTH ENGINE</div>
                <div class="topbtns">
                    <div class="topbtn" onclick="this.closest('.card').classList.toggle('fullscreen')">‚õ∂</div>
                    <div class="topbtn" onclick="let c=this.closest('.card');c.remove();forge.nodes=forge.nodes.filter(n=>n.id!==${node.id});forge.save();document.getElementById('count').textContent=forge.nodes.length+'/16';">√ó</div>
                </div>
            </div>
            <div class="content" id="c${node.id}"><i style="opacity:0.5">Ready for truth...</i></div>
            <div class="inputbar">
                <textarea class="input" id="i${node.id}" placeholder="What is the truth..."></textarea>
                <button class="send" onclick="forge.ask(${node.id})">‚û§</button>
            </div>
        `;
        this.makeDraggable(el.querySelector('.header'), node);
        this.canvas.appendChild(el);
        node.el = el;

        const ta = el.querySelector('.input');
        ta.addEventListener('input', () => { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; });
        ta.addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); forge.ask(node.id); } });
    }

    makeDraggable(header, node) {
        let startX, startY, startLeft, startTop;
        const move = e => {
            e.preventDefault();
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            node.el.style.left = (startLeft + (x - startX)) + 'px';
            node.el.style.top = (startTop + (y - startY)) + 'px';
        };
        const up = () => {
            const rect = node.el.getBoundingClientRect();
            node.x = (rect.left / innerWidth * 100);
            node.y = (rect.top / innerHeight * 100);
            node.el.style.left = node.x + 'vmin';
            node.el.style.top = node.y + 'vmin';
            node.el.classList.remove('dragging');
            this.save();
            document.removeEventListener('pointermove', move);
            document.removeEventListener('pointerup', up);
        };
        header.addEventListener('pointerdown', e => {
            if (e.target.classList.contains('topbtn')) return;
            node.el.classList.add('dragging');
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
            startLeft = node.el.offsetLeft;
            startTop = node.el.offsetTop;
            document.addEventListener('pointermove', move);
            document.addEventListener('pointerup', up);
            document.addEventListener('touchmove', move, {passive:false});
            document.addEventListener('touchend', up);
        });
    }

    async ask(id, forced = null) {
        const node = this.nodes.find(n => n.id == id);
        const input = document.getElementById('i' + id);
        const content = document.getElementById('c' + id);
        const query = forced || input.value.trim();
        if (!query) return;
        if (!forced) input.value = '';

        node.messages.push({role:'user', content:query});
        content.innerHTML += `<div class="message user">${marked.parse(query)}</div>`;
        content.scrollTop = content.scrollHeight;

        const ai = document.createElement('div');
        ai.className = 'message ai';
        ai.textContent = '‚ñã thinking';
        content.appendChild(ai);
        content.scrollTop = content.scrollHeight;

        const result = await this.truthEngine(query);
        ai.innerHTML = marked.parse(result);
        node.messages.push({role:'ai', content:result});
        content.scrollTop = content.scrollHeight;
        this.save();
    }

    async truthEngine(query) {
        let answer = "No truth found.";
        try {
            const r1 = await fetch('https://truthengine.ai-n.workers.dev/api/ai/truth', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({input:query,model:'polaris-alpha'})});
            if(r1.ok){const j=await r1.json();if(j.answer)answer=j.answer;}
            if(answer.includes("No truth")){
                const r2 = await fetch('https://truth.ai-n.workers.dev/api/truth/resolve', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({input:query.toLowerCase()})});
                if(r2.ok){const j=await r2.json();if(j.answer)answer=j.answer;}
            }
            if(answer.includes("No truth")){
                const r3 = await fetch('https://ai-proxy.ai-n.workers.dev/api/chat', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:`Detailed answer: ${query}`, model:'@preset/truth'})});
                if(r3.ok){const j=await r3.json();answer = j.response || j.answer || answer;}
            }
        } catch(e) {answer = `Error: ${e.message}`;}
        return answer;
    }

    clear() { if(confirm('Wipe the yard?')) { this.nodes=[]; this.canvas.innerHTML='<div class="yard"></div>'; localStorage.removeItem('truthyard16'); location.reload(); } }
    save() { localStorage.setItem('truthyard16', JSON.stringify(this.nodes.map(n=>({id:n.id,x:n.x,y:n.y,messages:n.messages||[]})))); document.getElementById('count').textContent = this.nodes.length+'/16'; }
    restore() { this.nodes.forEach(n=>this.render(n)); document.getElementById('count').textContent=this.nodes.length+'/16'; }
}
const forge = new Forge();
</script>
</body>
</html>