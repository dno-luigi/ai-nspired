<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ai-n Forge | 2x2 Yard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --gold: #facc15; --bg: #0a0a15; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui,-apple-system,sans-serif; }
        body { overflow:hidden; height:100dvh; background:radial-gradient(ellipse at top,#1e1b4b 0%,var(--bg) 70%); touch-action:pan-x pan-y; }
        #canvas { width:100vw; height:100dvh; position:relative; }

        .yard { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:90vmin; height:90vmin;
                border:4px solid rgba(250,204,21,0.4); border-radius:24px; box-shadow:0 0 80px rgba(250,204,21,0.4); pointer-events:none; }

        .card { position:absolute; width:42vmin; height:42vmin; min-width:300px; min-height:300px; background:rgba(255,255,255,0.08);
                backdrop-filter:blur(50px); border:2px solid rgba(255,255,255,0.15); border-radius:24px; overflow:hidden;
                box-shadow:0 20px 40px rgba(0,0,0,0.6); touch-action:none; transition:transform .3s; }
        .card.dragging { transform:scale(1.08); z-index:9999; }
        .card.fullscreen { position:fixed !important; top:0 !important; left:0 !important; width:100vw !important; height:100dvh !important;
                           z-index:10000; border-radius:0 !important; }

        .header { height:80px; padding:0 20px 0 80px; background:linear-gradient(135deg,rgba(250,204,21,0.2),rgba(250,204,21,0.05));
                  border-bottom:1px solid rgba(250,204,21,0.4); display:flex; align-items:center; justify-content:space-between; cursor:grab; }
        .header:active { cursor:grabbing; }
        .handle { position:absolute; left:16px; top:16px; width:48px; height:48px; background:var(--gold); color:#000;
                  border-radius:12px; display:grid; place-items:center; font-size:28px; font-weight:bold; }

        .title { font-weight:800; font-size:18px; color:white; }
        .btns button { width:44px; height:44px; margin:0 4px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3);
                       border-radius:50%; color:white; font-size:18px; }
        .close { background:rgba(239,68,68,0.6) !important; }

        .content { height:calc(100% - 140px); padding:16px; overflow-y:auto; color:white; font-size:14px; }
        .inputbar { height:60px; padding:10px; background:rgba(0,0,0,0.5); border-top:1px solid rgba(255,255,255,0.1); display:flex; gap:8px; }
        .input { flex:1; background:rgba(255,255,255,0.1); border:1px solid var(--gold); border-radius:12px; padding:10px; color:white; font-size:14px; }
        .send { width:44px; height:44px; background:var(--gold); color:#000; border:none; border-radius:50%; font-weight:bold; }

        .forgebar { position:fixed; top:16px; left:50%; transform:translateX(-50%); background:rgba(15,15,25,0.95); backdrop-filter:blur(40px);
                    padding:12px 20px; border-radius:50px; border:2px solid rgba(255,255,255,0.15); z-index:5000; display:flex; gap:16px; }
        .fbtn { width:60px; height:60px; background:rgba(250,204,21,0.2); border:2px solid var(--gold); border-radius:50%; color:var(--gold); font-size:24px; display:grid; place-items:center; }
        body:has(.fullscreen) .forgebar { opacity:0; pointer-events:none; }
    </style>
</head>
<body>
    <div id="canvas"><div class="yard"></div></div>

    <div class="forgebar">
        <button class="fbtn" onclick="forge.create('truth')">üîç</button>
        <button class="fbtn" onclick="forge.create('code')">üíª</button>
        <button class="fbtn" onclick="forge.create('sandbox')">üß™</button>
        <button class="fbtn" onclick="forge.create('session')">üóÑÔ∏è</button>
        <button class="fbtn" onclick="forge.clear()">üóëÔ∏è</button>
        <span style="color:#facc15; font-weight:bold;" id="count">0/4</span>
    </div>

<script>
class Forge {
    constructor() {
        this.nodes = JSON.parse(localStorage.getItem('forge2x2')||'[]');
        this.canvas = document.getElementById('canvas');
        this.positions = [
            {x:8,  y:8},   // top-left
            {x:50, y:8},   // top-right
            {x:8,  y:50},  // bottom-left
            {x:50, y:50}   // bottom-right
        ];
        this.restore();
    }
    create(type) {
        if (this.nodes.length >= 4) return alert("Yard full ‚Äì only 4 cards allowed");
        const free = this.positions.find(p => !this.nodes.some(n => n.x===p.x && n.y===p.y));
        if (!free) return;
        const node = {id:Date.now(), type, x:free.x, y:free.y, content:''};
        this.nodes.push(node);
        this.render(node);
        this.save();
    }
    render(node) {
        const el = document.createElement('div');
        el.className = 'card';
        el.style.left = node.x + 'vmin';
        el.style.top = node.y + 'vmin';
        el.innerHTML = `
            <div class="handle">‚ò∞</div>
            <div class="header">
                <div class="title">${node.type.toUpperCase()}</div>
                <div class="btns">
                    <button onclick="forge.send('${node.id}')">‚ñ∂</button>
                    <button onclick="forge.fullscreen(this)">‚õ∂</button>
                    <button onclick="forge.saveCard('${node.id}')">üíæ</button>
                    <button class="close" onclick="forge.remove('${node.id}')">‚úï</button>
                </div>
            </div>
            <div class="content" id="c${node.id}">${node.type==='truth'?marked.parse(node.content||'Ready...'):''}</div>
            ${node.type==='truth'?`<div class="inputbar"><textarea class="input" id="i${node.id}" placeholder="Ask truth..."></textarea><button class="send" onclick="forge.send('${node.id}')">‚û§</button></div>`:''}
        `;
        this.makeDraggable(el.querySelector('.header'), node);
        this.makeDraggable(el.querySelector('.handle'), node);
        this.canvas.appendChild(el);
        node.el = el;
    }
    makeDraggable(header, node) {
        let startX, startY;
        const move = e => {
            e.preventDefault();
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            node.el.style.left = (node.x + (x-startX)/window.innerWidth*100) + 'vmin';
            node.el.style.top  = (node.y + (y-startY)/window.innerHeight*100) + 'vmin';
        };
        const up = () => {
            const free = this.positions.find(p => !this.nodes.some(n => n!==node && n.x===p.x && n.y===p.y));
            node.x = free.x; node.y = free.y;
            node.el.style.left = node.x+'vmin';
            node.el.style.top  = node.y+'vmin';
            node.el.classList.remove('dragging');
            this.save();
            document.removeEventListener('pointermove',move);
            document.removeEventListener('pointerup',up);
            document.removeEventListener('touchmove',move);
            document.removeEventListener('touchend',up);
        };
        header.addEventListener('pointerdown', e => {
            if (e.target.tagName==='BUTTON') return;
            e.preventDefault();
            node.el.classList.add('dragging');
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
            document.addEventListener('pointermove',move);
            document.addEventListener('pointerup',up);
            document.addEventListener('touchmove',move,{passive:false});
            document.addEventListener('touchend',up);
        });
    }
    send(id) {
        const node = this.nodes.find(n=>n.id==id);
        if (!node) return;
        const input = document.getElementById('i'+id);
        if (!input || !input.value.trim()) return;
        // Put your truth engine call here later
        document.getElementById('c'+id).innerHTML = marked.parse(input.value);
        input.value = '';
    }
    fullscreen(btn) { btn.closest('.card').classList.toggle('fullscreen'); }
    remove(id) {
        const node = this.nodes.find(n=>n.id==id);
        node.el.style.transform = 'scale(0)';
        setTimeout(()=>{ node.el.remove(); this.nodes=this.nodes.filter(n=>n.id!=id); this.save(); },400);
    }
    saveCard(id) { /* add later */ }
    clear() { if(confirm('Clear all?')) { this.nodes=[]; this.canvas.innerHTML='<div class="yard"></div>'; localStorage.removeItem('forge2x2'); document.getElementById('count').textContent='0/4'; } }
    save() { localStorage.setItem('forge2x2',JSON.stringify(this.nodes.map(n=>({id:n.id,type:n.type,x:n.x,y:n.y,content:n.content||''})))); document.getElementById('count').textContent=this.nodes.length+'/4'; }
    restore() {
        this.nodes.forEach(n=>this.render(n));
        document.getElementById('count').textContent = this.nodes.length+'/4';
    }
}
const forge = new Forge();
</script>
</body>
</html>