<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ai-n construct | Collaborative Card Containers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #faf9f6;
            --bg-secondary: #f5f3ee;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --accent-primary: #2d5016;
            --accent-secondary: #4a7c59;
            --card-shadow: 0 8px 32px rgba(0,0,0,0.08);
            --border-subtle: rgba(0,0,0,0.06);
            --serif: 'EB Garamond', serif;
            --sans: 'Inter', sans-serif;
        }
        .dark {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --accent-primary: #4ade80;
            --accent-secondary: #22c55e;
        }
        .neo {
            --bg-primary: #000;
            --bg-secondary: #0a0a0a;
            --text-primary: #00ff41;
            --text-secondary: #00aa2f;
            --accent-primary: #00ff41;
            --accent-secondary: #00ff88;
            font-family: var(--sans);
        }
        body { 
            font-family: var(--serif);
            line-height: 1.8;
            font-size: 1.1rem;
            letter-spacing: 0.025em;
        }
        .e-reader { 
            max-width: 800px; margin: 0 auto; 
            font-feature-settings: 'kern' 1, 'liga' 1, 'clig' 1, 'calt' 1;
        }
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.25,0.46,0.45,0.94);
            overflow: hidden;
            position: relative;
            cursor: grab;
        }
        .card:hover { 
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .card.fullscreen {
            position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 1000; border-radius: 0; max-width: none;
        }
        .card.fullscreen::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 60px;
            background: linear-gradient(to bottom, var(--bg-primary), transparent);
            z-index: 10;
        }
        .card-header {
            display: flex; justify-content: between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
        }
        .card-content { padding: 2.5rem; max-height: 500px; overflow-y: auto; }
        .card.fullscreen .card-content { max-height: none; height: calc(100vh - 120px); padding: 4rem 3rem; }
        .prose { color: var(--text-primary); }
        .prose code { background: rgba(45,80,22,0.1); padding: 0.25rem 0.5rem; border-radius: 8px; font-family: var(--sans); }
        .neo .prose code { background: rgba(0,255,65,0.2); }
        .slide-panel { 
            transform: translateX(-100%); transition: transform 0.4s ease-out;
        }
        .slide-panel.open { transform: translateX(0); }
        .panel-overlay { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .panel-overlay.open { opacity: 1; visibility: visible; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card.fade-in { animation: fadeInUp 0.6s ease-out; }
        .drag-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1001; pointer-events: none; }
        .code-editor { background: #1e1e1e; color: #d4d4d4; font-family: 'Fira Code', monospace; }
        .sandbox-output { background: #0f0f0f; color: #00ff41; padding: 1rem; border-radius: 12px; font-family: var(--sans); }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-[var(--bg-primary)] to-[var(--bg-secondary)] p-4 md:p-8">
    <div class="e-reader relative">
        <!-- Header -->
        <header class="flex items-center justify-between mb-12">
            <div class="flex gap-4">
                <button id="menuBtn" class="w-14 h-14 bg-[var(--bg-secondary)] rounded-3xl flex items-center justify-center text-xl hover:bg-[var(--accent-primary)] transition-all" title="Menu">
                    <i class="fas fa-bars"></i>
                </button>
                <button id="historyBtn" class="w-14 h-14 bg-[var(--bg-secondary)] rounded-3xl flex items-center justify-center text-xl hover:bg-[var(--accent-primary)] transition-all" title="History">
                    <i class="fas fa-history"></i>
                </button>
            </div>
            <div class="text-3xl font-bold text-[var(--accent-primary)] flex items-center gap-3">
                <i class="fas fa-cube text-2xl"></i>
                ai-nspired 
            </div>
            <div class="flex gap-4">
                <button id="newSessionBtn" class="w-14 h-14 bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)] text-white rounded-3xl flex items-center justify-center text-xl font-bold hover:scale-110 transition-all" title="New Session">
                    ‚ûï
                </button>
            </div>
        </header>

        <!-- Cards Grid -->
        <main id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
            <!-- Dynamic cards here -->
        </main>

        <!-- Input Bar -->
        <div class="fixed bottom-8 left-1/2 transform -translate-x-1/2 w-full max-w-2xl bg-[var(--bg-secondary)] backdrop-blur-xl rounded-3xl p-6 border border-[var(--border-subtle)] shadow-2xl">
            <div class="flex gap-4 items-end">
                <div class="flex-1 relative">
                    <textarea 
                        id="inputQuery" 
                        rows="2" 
                        class="w-full bg-transparent border-none outline-none text-lg resize-none font-serif placeholder-[var(--text-secondary)] pr-20 pb-4"
                        placeholder="ask... "
                    ></textarea>
                    <div class="absolute bottom-0 right-0 text-xs text-[var(--text-secondary)]">Supports /truth /code /sandbox /combine</div>
                </div>
                <button id="sendBtn" class="w-20 h-20 bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)] text-white rounded-3xl flex items-center justify-center text-2xl font-bold hover:scale-110 shadow-xl transition-all">
                    <i class="fas fa-rocket"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Left Panel: Menu -->
    <div id="menuPanel" class="slide-panel fixed top-0 left-0 w-80 h-full bg-[var(--bg-primary)] shadow-2xl z-[1001] overflow-y-auto">
        <div class="p-8 border-b border-[var(--border-subtle)]">
            <h2 class="text-2xl font-bold text-[var(--accent-primary)] mb-6">‚öôÔ∏è NeoForge Control</h2>
             <!-- ADD INSIDE menuPanel, after h2 -->
            <button onclick="togglePanel('menuPanel')" class="absolute top-8 right-8 text-xl text-[var(--text-secondary)] hover:text-[var(--accent-primary)]">
              <i class="fas fa-times"></i>
                  </button>
              <div class="space-y-4 text-sm">
                <div>
                    <label class="block font-semibold mb-2 text-[var(--text-secondary)]">Theme</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="theme-btn p-3 rounded-xl border-2 border-transparent hover:border-[var(--accent-primary)] active-theme" data-theme="default">üìñ</button>
                        <button class="theme-btn p-3 rounded-xl border-2 border-transparent hover:border-[var(--accent-primary)]" data-theme="dark">üåô</button>
                        <button class="theme-btn p-3 rounded-xl border-2 border-transparent hover:border-[var(--accent-primary)]" data-theme="neo">üíö</button>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-[var(--text-secondary)]">Inference Mode</label>
                    <select id="inferenceMode" class="w-full p-3 bg-[var(--bg-secondary)] border border-[var(--border-subtle)] rounded-2xl font-serif">
                        <option value="truth">Truth Engine (KV‚ÜíResolve‚ÜíSynth)</option>
                        <option value="code">Code Gen (JS/Python)</option>
                        <option value="sandbox">Sandbox Exec</option>
                        <option value="chat">Matrix Chat</option>
                    </select>
                </div>
                <button id="exportSession" class="w-full p-4 bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)] text-white font-bold rounded-2xl hover:scale-105 transition-all">
                    <i class="fas fa-download mr-2"></i>Export Cards
                </button>
            </div>
        </div>
    </div>

    <!-- Right Panel: History -->
    <div id="historyPanel" class="slide-panel fixed top-0 right-0 w-96 h-full bg-[var(--bg-primary)] shadow-2xl z-[1001] overflow-y-auto">
        <div class="p-8 border-b border-[var(--border-subtle)] sticky top-0 bg-[var(--bg-primary)]">
            <h2 class="text-2xl font-bold text-[var(--accent-primary)] mb-6">üìú Card History</h2>
            <div id="historyList" class="space-y-4"></div>
        </div>
    </div>

    <!-- Drag Overlay -->
    <div id="dragOverlay" class="drag-overlay hidden"></div>

    <!-- Fullscreen Backdrop -->
    <div id="fullscreenBackdrop" class="panel-overlay hidden"></div>
<!-- ADD THIS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
const appState = {
    cards: JSON.parse(localStorage.getItem('neoforge-cards') || '[]'),
    history: JSON.parse(localStorage.getItem('neoforge-history') || '[]'),
    theme: localStorage.getItem('neoforge-theme') || 'default'
};

function saveState() {
    localStorage.setItem('neoforge-cards', JSON.stringify(appState.cards));
    localStorage.setItem('neoforge-history', JSON.stringify(appState.history));
    localStorage.setItem('neoforge-theme', appState.theme);
}

function normalizeInput(str) { return str.trim().toLowerCase().replace(/\s+/g, ' ').replace(/[^a-zA-Z0-9\-_]/g, ''); }
function normalizeId(str) { return `prov_${str.trim().toLowerCase().replace(/[^a-zA-Z0-9]/g, '_')}`; }

function applyTheme(theme) {
    document.body.className = theme;
    appState.theme = theme;
    saveState();
}

function togglePanel(panelId) {
    document.getElementById(panelId).classList.toggle('open');
    document.getElementById('fullscreenBackdrop').classList.toggle('open');
}

function createCard(data, isHistory = false) {
    const id = data.id || `card-${Date.now()}`;
    const typeIcon = data.type === 'truth' ? 'üîç' : 'üìÑ';
    const sourceClass = data.source ? `source-badge source-${data.source}` : '';
    const card = document.createElement('div');
    card.className = `card fade-in relative group ${isHistory ? 'opacity-70 hover:opacity-100' : ''}`;
    card.dataset.id = id;
    card.innerHTML = `
        <div class="card-header" style="justify-content: space-between;">
            <div class="flex items-center gap-3">
                <span class="text-2xl">${typeIcon}</span>
                <span class="font-bold text-lg">${data.title || 'Truth'}</span>
                ${data.source ? `<span class="${sourceClass}">${data.source.toUpperCase()}</span>` : ''}
            </div>
            <div class="flex gap-2">
                ${!isHistory ? `
                    <button onclick="expandCard('${id}')" class="w-10 h-10 rounded-2xl bg-[var(--accent-primary)]/20 hover:bg-[var(--accent-primary)] text-[var(--accent-primary)] flex items-center justify-center">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button onclick="closeFullscreen()" class="w-10 h-10 rounded-2xl bg-red-500/30 hover:bg-red-500 text-red-200 flex items-center justify-center absolute top-2 right-2 z-50 card-fullscreen-only">
                    </button>
                ` : ''}
            </div>
        </div>
        <div class="card-content prose">${marked.parse(data.content || '')}</div>
    `;
    return card;
}

function renderCards() {
    const grid = document.getElementById('cardsGrid');
    grid.innerHTML = '';
    appState.cards.forEach(card => grid.appendChild(createCard(card)));
}

function renderHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    appState.history.slice(0, 20).forEach(card => list.appendChild(createCard(card, true)));
}

window.expandCard = function(id) {
    document.querySelector(`[data-id="${id}"]`).classList.add('fullscreen');
    document.getElementById('fullscreenBackdrop').classList.add('open');
};

window.closeFullscreen = function() {
    document.querySelector('.card.fullscreen')?.classList.remove('fullscreen');
    document.getElementById('fullscreenBackdrop').classList.remove('open');
};

async function executeTruthEngine(query) {
    const result = { type: 'truth', title: 'Truth Engine', content: 'üîç Checking Legacy KV...', source: 'processing' };
    const tempId = `temp-${Date.now()}`;
    result.id = tempId;
    appState.cards.unshift(result);
    saveState();
    renderCards();

    try {
        // Step 1: Legacy KV
        const legacyRes = await fetch('https://truthengine.ai-n.workers.dev/api/ai/truth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: query, model: 'polaris-alpha' })
        });
        const legacyData = await legacyRes.json().catch(() => ({}));

        if (legacyRes.ok && legacyData.answer) {
            result.content = legacyData.answer;
            result.source = 'legacy';
        } else {
            // Step 2: Resolve
            result.content = 'üîç Checking Resolve...';
            renderCards();
            const resolveRes = await fetch('https://truth.ai-n.workers.dev/api/truth/resolve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input: normalizeInput(query) })
            });
            const resolveData = await resolveRes.json().catch(() => ({}));

            if (resolveRes.ok && resolveData.answer) {
                result.content = resolveData.answer;
                result.source = 'resolve';
            } else {
                // Step 3: AI Proxy
                result.content = 'üîç AI Proxy...';
                renderCards();
                const proxyRes = await fetch('https://ai-proxy.ai-n.workers.dev/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Generate detailed answer about: ${query.trim()}`, model: 'auto' })
                });
                const proxyData = await proxyRes.json().catch(() => ({}));

                if (proxyRes.ok) {
                    result.content = proxyData.response || proxyData.answer || 'No AI response';
                    result.source = 'ai';
                    // Step 4: Save Provisional (silent)
                    fetch('https://truth.ai-n.workers.dev/api/truth/provisional/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: normalizeId(query),
                            answer: result.content,
                            meta: { model: 'justice-approved', confidence: 0.85, source: 'proxy_ai', qc_passed: false }
                        })
                    }).catch(console.log);
                } else {
                    result.content = '‚ùå No truth found';
                    result.source = 'not_found';
                }
            }
        }
    } catch (e) {
        result.content = `‚ùå Error: ${e.message}`;
        result.source = 'error';
    }

    // Update card
    result.id = `card-${Date.now()}`;
    appState.cards[0] = result;
    appState.history.unshift({ ...result, preview: result.content.slice(0, 100) });
    if (appState.cards.length > 50) appState.cards = appState.cards.slice(0, 50);
    saveState();
    renderCards();
    renderHistory();
}

document.addEventListener('DOMContentLoaded', function() {
    applyTheme(appState.theme);
    renderCards();
    renderHistory();

    // Menu buttons
    document.getElementById('menuBtn').onclick = () => togglePanel('menuPanel');
    document.getElementById('historyBtn').onclick = () => togglePanel('historyPanel');
    document.getElementById('fullscreenBackdrop').onclick = closeFullscreen;

    // Theme buttons
    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelector('.active-theme').classList.remove('active-theme', 'bg-[var(--accent-primary)]', 'text-white');
            btn.classList.add('active-theme', 'bg-[var(--accent-primary)]', 'text-white');
            applyTheme(btn.dataset.theme);
        };
    });

    // Send button
    const sendBtn = document.getElementById('sendBtn');
    const input = document.getElementById('inputQuery');
    sendBtn.onclick = () => {
        const query = input.value.trim();
        if (query) {
            executeTruthEngine(query);
            input.value = '';
        }
    };
    input.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendBtn.click();
        }
    };

    // New session
    document.getElementById('newSessionBtn').onclick = () => {
        appState.cards = [];
        saveState();
        renderCards();
    };

    // Export
    document.getElementById('exportSession').onclick = () => {
        const blob = new Blob([JSON.stringify(appState, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'neoforge.json';
        a.click();
    };
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeFullscreen();
});
</script>
</body>
</html>