<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Truth Orchestrator - Workflow Tester</title>
  <style>
    body { font-family: monospace; margin: 2em; background: #121212; color: #eee; }
    h1, h2 { color: #b388ff; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, textarea, select, button { margin-top: 0.5em; width: 100%; padding: 0.5em; background: #222; color: #fff; border: 1px solid #444; }
    .endpoint { border: 1px solid #444; padding: 1em; margin-bottom: 2em; border-radius: 8px; background: #1e1e1e; }
    .output { margin-top: 1em; background: #111; color: #a8ffc4; padding: 1em; border-radius: 4px; font-size: 0.95em; white-space: pre-wrap; }
    .error { color: #ff557c; }
    .status { font-weight: bold; margin-left: 1em; }
    .time { color: #888; font-size: 0.9em; }
    .collapsible { cursor: pointer; background: #2c2c2c; color: #b388ff; padding: 0.5em; border: none; text-align: left; outline: none; display: block; width: 100%; margin-top: 1em; }
    .collapsible:after { content: '\002B'; float: right; }
    .active:after { content: "\2212"; }
    .content { padding: 0 1em; display: none; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .content.expanded { display: block; max-height: 1000px; }
    .preflight-info {
      background: #1a1a1a;
      border-left: 3px solid #4caf50;
      padding: 0.5em;
      margin: 0.5em 0;
      font-size: 0.9em;
      border-radius: 4px;
    }
    .technical-detail {
      background: #2a2a2a;
      padding: 0.5em;
      margin: 0.5em 0;
      border-radius: 4px;
      font-size: 0.85em;
      border-left: 3px solid #2196f3;
    }
    .purpose-explanation {
      background: #3a3a3a;
      padding: 0.5em;
      margin: 0.5em 0;
      border-radius: 4px;
      font-size: 0.85em;
      border-left: 3px solid #ff9800;
    }
    .formula {
      background: #444;
      padding: 0.5em;
      margin: 0.5em 0;
      border-radius: 4px;
      font-size: 0.9em;
      border-left: 3px solid #9c27b0;
      font-family: monospace;
    }
    .base-url-highlight {
      background: #ff9800;
      color: #000;
      padding: 0.2em 0.5em;
      border-radius: 3px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üîç Truth Orchestrator - Workflow Tester</h1>
  <p>Test the complete workflow: Legacy KV ‚Üí Resolve ‚Üí AI Proxy ‚Üí Provisional</p>

  <form id="base">
    <label>Base URL <span style="color: grey">(e.g. https://your-worker.dev)</span></label>
    <input type="url" id="baseUrl" value="http://localhost:8787" required />

    <label>Optional Auth Token (if required)</label>
    <input type="text" id="authToken" placeholder="Bearer ..." />
  </form>

  <!-- Step 1: Legacy KV Test -->
  <button class="collapsible">‚ñ∂Ô∏è Step 1: Legacy KV Lookup</button>
  <div class="endpoint content">
    <label>Legacy Input <span style="color: grey">(e.g. "about-cybrjustice", "Ranger1185")</span></label>
    <input type="text" id="legacyInput" value="about-cybrjustice" />
    <button onclick="testLegacyStep1()">Check Legacy KV</button>
    <div class="preflight-info">
      <strong>Pre-flight Check:</strong> 
      <div>Endpoint: <code>POST https://truthengine.ai-n.workers.dev/api/ai/truth</code></div>
      <div class="purpose-explanation">
        <strong>Why This Exists:</strong><br>
        - First validation in workflow to check legacy storage<br>
        - Avoids unnecessary computation when data already exists<br>
        - Maintains backward compatibility with old truth database<br>
        - Used for migration and data integrity checking<br>
        - Returns 404 if not found, success if found
      </div>
      <div class="formula">
        <strong>Exact Legacy Normalization Formula:</strong><br>
        <code>REQUEST = {"input": normalizeString(input), "model": "polaris-alpha"}</code><br>
        <code>normalizeString(str) = str.trim().toLowerCase().replace(/\s+/g, ' ')</code><br>
        <code>WHERE: str = input parameter provided by user</code>
      </div>
      <div class="technical-detail">
        <strong>Implementation Details:</strong><br>
        <strong>Base URL:</strong> <span class="base-url-highlight">https://truthengine.ai-n.workers.dev</span><br>
        <strong>Input Processing:</strong> <code>normalizeString(input)</code> with strict matching<br>
        <strong>Model Parameter:</strong> Always <code>"polaris-alpha"</code> for legacy compatibility<br>
        <strong>Validation:</strong> Exact case-sensitive string match in legacy KV<br>
        <strong>Error Handling:</strong> Returns proper HTTP codes (404, 422) when missing<br>
        <strong>Security:</strong> Required model validation for authentic legacy calls
      </div>
      <div>Validates legacy data in KV store</div>
    </div>
    <div class="output" id="legacyOutput"></div>
  </div>

  <!-- Step 2: Resolve Check -->
  <button class="collapsible">‚ñ∂Ô∏è Step 2: Check Master/Provisional Truths</button>
  <div class="endpoint content">
    <label>Query Input</label>
    <input type="text" id="resolveInput2" value="about-cybrjustice" />
    <button onclick="testResolveStep2()">Check Resolve</button>
    <div class="preflight-info">
      <strong>Pre-flight Check:</strong> 
      <div>Endpoint: <code>POST https://truth.ai-n.workers.dev/api/truth/resolve</code></div>
      <div class="purpose-explanation">
        <strong>Why This Exists:</strong><br>
        - Checks new truth resolution system<br>
        - Centralized approach for master/provisional truth access<br>
        - Prevents duplicate processing of existing verified knowledge<br>
        - Provides layer information (master, provisional, or not_found)<br>
        - Maintains system consistency and data quality
      </div>
      <div class="formula">
        <strong>Exact Resolution Normalization Formula:</strong><br>
        <code>REQUEST = {"input": normalizeInput(input)}</code><br>
        <code>normalizeInput(str) = str.trim().toLowerCase().replace(/\s+/g, ' ').replace(/[^a-zA-Z0-9\-_]/g, '')</code><br>
        <code>WHERE: str = input parameter provided by user</code>
      </div>
      <div class="technical-detail">
        <strong>Implementation Details:</strong><br>
        <strong>Base URL:</strong> <span class="base-url-highlight">https://truth.ai-n.workers.dev</span><br>
        <strong>Input Processing:</strong> <code>normalizeInput(input)</code> for resolution<br>
        <strong>Workflow:</strong> Master check first, then Provisional check<br>
        <strong>Metadata:</strong> Returns layer, confidence, timestamp details<br>
        <strong>Return Values:</strong> Success with answer + metadata or 404<br>
        <strong>Performance:</strong> Optimized lookup with caching layer
      </div>
      <div>Checks existing Master/Provisional truths</div>
    </div>
    <div class="output" id="resolveOutput2"></div>
  </div>

  <!-- Step 3: AI Proxy Query -->
  <button class="collapsible">‚ñ∂Ô∏è Step 3: AI Proxy Query</button>
  <div class="endpoint content">
    <label>Query Input</label>
    <input type="text" id="proxyInput" value="about-cybrjustice" />
    <label>Request Type</label>
    <select id="proxyType">
      <option value="chat">Chat (Conversational)</option>
      <option value="code">Code Generation</option>
      <option value="mcp">MCP/Tool Enabled</option>
      <option value="generate">Generic Request</option>
    </select>
    <button onclick="testProxyStep3()">Query AI Proxy</button>
    <div class="preflight-info">
      <strong>Pre-flight Check:</strong> 
      <div>Endpoint: <code>POST https://ai-proxy.ai-n.workers.dev/{ENDPOINT}</code></div>
      <div class="purpose-explanation">
        <strong>Why This Exists:</strong><br>
        - Only executes when no existing truth found in previous steps<br>
        - Provides AI-generated knowledge when data is missing<br>
        - Budget-optimized with cost control<br>
        - Ensures quality of AI responses<br>
        - Maintains system consistency across AI models
      </div>
      <div class="formula">
        <strong>Exact AI Query Normalization Formula:</strong><br>
        <code>REQUEST = {"message": formatMessage(input), "model": "auto"}</code><br>
        <code>formatMessage(str) = "Generate detailed answer about: " + str.trim()</code><br>
        <code>WHERE: str = input parameter provided by user</code>
      </div>
      <div class="technical-detail">
        <strong>Implementation Details:</strong><br>
        <strong>Base URL:</strong> <span class="base-url-highlight">https://ai-proxy.ai-n.workers.dev</span><br>
        <strong>Input Formatting:</strong> <code>formatMessage(input)</code> for context<br>
        <strong>Model Selection:</strong> <code>"auto"</code> triggers budget optimization<br>
        <strong>Cost Control:</strong> Max $0.20 per million tokens enforced<br>
        <strong>Feature Support:</strong> Tool/MCP selection based on model capabilities<br>
        <strong>Validation:</strong> Cost and model compatibility validation
      </div>
      <div>Uses budget-optimized OpenRouter models</div>
    </div>
    <div class="output" id="proxyOutput"></div>
  </div>

  <!-- Step 4: Save as Provisional -->
  <button class="collapsible">‚ñ∂Ô∏è Step 4: Save as Provisional Truth</button>
  <div class="endpoint content">
    <label>Provisional ID</label>
    <input type="text" id="provIdInput" value="about-cybrjustice" />
    <label>Answer</label>
    <textarea id="provAnswerInput" rows="3">This is a test answer from AI</textarea>
    <button onclick="testProvisionalStep4()">Save as Provisional</button>
    <div class="preflight-info">
      <strong>Pre-flight Check:</strong> 
      <div>Endpoint: <code>POST https://truth.ai-n.workers.dev/api/truth/provisional/update</code></div>
      <div class="purpose-explanation">
        <strong>Why This Exists:</strong><br>
        - Final step for persisting AI-generated knowledge<br>
        - Creates temporary entry pending expert verification<br>
        - Maintains traceability and audit history<br>
        - Enables expert review workflows<br>
        - Prevents loss of valuable generated information
      </div>
      <div class="formula">
        <strong>Exact Provisional Save Formula:</strong><br>
        <code>REQUEST = {</code><br>
        <code>&nbsp;&nbsp;"id": normalizeId(input),</code><br>
        <code>&nbsp;&nbsp;"answer": answer,</code><br>
        <code>&nbsp;&nbsp;"meta": {</code><br>
        <code>&nbsp;&nbsp;&nbsp;&nbsp;"model": "justice-approved",</code><br>
        <code>&nbsp;&nbsp;&nbsp;&nbsp;"confidence": 0.85,</code><br>
        <code>&nbsp;&nbsp;&nbsp;&nbsp;"source": "proxy_ai",</code><br>
        <code>&nbsp;&nbsp;&nbsp;&nbsp;"qc_passed": false</code><br>
        <code>&nbsp;&nbsp;}</code><br>
        <code>}</code><br>
        <code>normalizeId(str) = "prov_" + str.trim().toLowerCase().replace(/[^a-zA-Z0-9]/g, '_')</code>
      </div>
      <div class="technical-detail">
        <strong>Implementation Details:</strong><br>
        <strong>Base URL:</strong> <span class="base-url-highlight">https://truth.ai-n.workers.dev</span><br>
        <strong>ID Generation:</strong> <code>normalizeId(input)</code> for consistency<br>
        <strong>Metadata Structure:</strong> Fixed schema with required fields<br>
        <strong>QC Status:</strong> Default <code>false</code> for expert verification<br>
        <strong>Validation:</strong> JSON metadata schema validation<br>
        <strong>Versioning:</strong> Automatic timestamp-based versioning
      </div>
      <div>Saves AI response as provisional truth</div>
    </div>
    <div class="output" id="provOutput"></div>
  </div>

  <script>
    function fmtErr(err) {
      return `<span class="error">Error: ${err}</span>`;
    }

    function fmtResp({ status, data, duration, url, method }) {
      let out = `[${new Date().toISOString()}] ${method} ${url}\n`;
      out += `<span class="status" style="color:${status==200||status==201?'#0f6':'error'}">${status}</span> `;
      out += `<span class="time">‚è±Ô∏è ${duration?.toFixed(2)}ms</span>\n\n`;
      out += `RESPONSE:\n${JSON.stringify(data, null, 2)}`;
      return out;
    }

    async function apiFetch(path, payload, method = "POST") {
      const base = document.getElementById("baseUrl").value.trim().replace(/\/+$/, "");
      const url = `${base}${path}`;
      const headers = { "Content-Type": "application/json" };
      const auth = document.getElementById("authToken").value.trim();
      if (auth) headers["Authorization"] = auth;

      const start = performance.now();
      try {
        const res = await fetch(url, {
          method,
          headers,
          ...(payload && method !== "GET" ? { body: JSON.stringify(payload) } : {})
        });

        const data = await res.text().catch(() => "");
        let json;
        try { json = JSON.parse(data); } catch { json = { raw: data, parseError: true }; }
        const end = performance.now();
        return { ok: res.ok, data: json, status: res.status, duration: end - start, url, method };
      } catch (err) {
        const end = performance.now();
        return { ok: false, data: { error: err.message }, status: null, duration: end - start, url, method };
      }
    }

    function addPreflightTest(path, name, method = "POST") {
      const btn = document.createElement("button");
      btn.textContent = "Preflight ‚úÖ";
      btn.style.marginTop = "0.5em";
      btn.onclick = async () => {
        const res = await apiFetch(path, undefined, "OPTIONS");
        document.getElementById(name + "Output").textContent += "\n" + fmtResp(res);
      };
      document.getElementById(name + "Output").parentNode.insertBefore(btn, document.getElementById(name + "Output"));
    }

    // Collapsible
    document.querySelectorAll(".collapsible").forEach(btn => {
      btn.onclick = function () {
        this.classList.toggle("active");
        const content = this.nextElementSibling;
        content.classList.toggle("expanded");
      };
    });

    // Step 1: Legacy KV Lookup
    async function testLegacyStep1() {
      const input = document.getElementById("legacyInput").value.trim();
      const out = document.getElementById("legacyOutput");
      if (!input) {
        out.innerHTML = "Error: Legacy input is required.";
        return;
      }
      
      // Using the exact same approach as in the legacy system
      const LEGACY_URL = 'https://truthengine.ai-n.workers.dev/api/ai/truth';
      out.innerHTML = "Checking Legacy KV...";
      
      try {
        const res = await fetch(LEGACY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ input, model: 'polaris-alpha' })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          out.innerHTML = `Legacy error ${res.status}: ${JSON.stringify(data)}`;
          return;
        }
        if (!data.answer) {
          out.innerHTML = 'Legacy returned no answer for that input.';
          return;
        }
        out.innerHTML = `SUCCESS: Found in Legacy KV\n\n${data.answer}`;
      } catch (e) {
        out.innerHTML = `Legacy fetch failed: ${e.message}`;
      }
    }

    // Step 2: Resolve Check using /api/truth/resolve
    async function testResolveStep2() {
      const input = document.getElementById("resolveInput2").value.trim();
      const out = document.getElementById("resolveOutput2");
      if (!input) {
        out.innerHTML = "Error: Input required.";
        return;
      }
      out.innerHTML = "Checking Master/Provisional truths...";
      const res = await apiFetch("/api/truth/resolve", { input });
      out.innerHTML = fmtResp(res);
    }

    // Step 3: AI Proxy Query using correct proxy URL and endpoints
    async function testProxyStep3() {
      const input = document.getElementById("proxyInput").value.trim();
      const proxyType = document.getElementById("proxyType").value;
      const out = document.getElementById("proxyOutput");
      
      if (!input) {
        out.innerHTML = "Error: Input required.";
        return;
      }
      
      // Use the correct proxy service URL
      const proxyBaseUrl = 'https://ai-proxy.ai-n.workers.dev';
      out.innerHTML = `Querying AI proxy (${proxyType})...`;
      
      try {
        let proxyEndpoint, bodyData;
        
        switch(proxyType) {
          case 'chat':
            proxyEndpoint = '/api/chat';
            bodyData = { message: input };
            break;
          case 'code':
            proxyEndpoint = '/api/code';
            bodyData = { prompt: input, language: 'javascript' };
            break;
          case 'mcp':
            proxyEndpoint = '/api/mcp';
            bodyData = { message: input, useCase: 'general' };
            break;
          case 'generate':
            proxyEndpoint = '/api/generate';
            bodyData = { prompt: input, format: 'text' };
            break;
          default:
            proxyEndpoint = '/api/chat';
            bodyData = { message: input };
        }
        
        const res = await fetch(`${proxyBaseUrl}${proxyEndpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyData)
        });
        
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          out.innerHTML = `SUCCESS: ${proxyType} response:\n\n${JSON.stringify(data, null, 2)}`;
        } else {
          out.innerHTML = `ERROR ${res.status}: ${JSON.stringify(data, null, 2)}`;
        }
        
      } catch (error) {
        out.innerHTML = `Error: ${error.message}`;
      }
    }

    // Step 4: Save as Provisional Truth
    async function testProvisionalStep4() {
      const id = document.getElementById("provIdInput").value.trim();
      const answer = document.getElementById("provAnswerInput").value.trim();
      const out = document.getElementById("provOutput");
      if (!id || !answer) {
        out.innerHTML = "Error: ID and answer required.";
        return;
      }
      out.innerHTML = "Saving as provisional truth...";
      const res = await apiFetch("/api/truth/provisional/update", {
        id: id,
        answer: answer,
        meta: {
          model: 'justice-approved',
          confidence: 0.85,
          source: 'proxy_ai',
          qc_passed: false
        }
      });
      out.innerHTML = fmtResp(res);
    }

    // Add preflight buttons for ALL steps
    addPreflightTest("/api/ai/truth", "legacyStep1", "POST");       // Legacy KV endpoint
    addPreflightTest("/api/truth/resolve", "resolveStep2", "POST"); // Resolve endpoint
    addPreflightTest("/api/chat", "proxyStep3Chat", "POST");        // Proxy chat endpoint
    addPreflightTest("/api/code", "proxyStep3Code", "POST");        // Proxy code endpoint
    addPreflightTest("/api/mcp", "proxyStep3Mcp", "POST");          // Proxy mcp endpoint
    addPreflightTest("/api/generate", "proxyStep3Generate", "POST"); // Proxy generate endpoint
    addPreflightTest("/api/truth/provisional/update", "provisionalStep4", "POST"); // Provisional endpoint

    // All other endpoints for completeness
    addPreflightTest("/api/truth/master/create", "masterCreate");
    addPreflightTest("/api/truth/master/update", "masterUpdate");
    addPreflightTest("/api/truth/master/delete", "masterDelete");
    addPreflightTest("/api/truth/provisional/delete", "provDelete");
    addPreflightTest("/api/truth/provisional/query", "query");
    addPreflightTest("/api/truth/promote", "promote");
    addPreflightTest("/debug/kv-status", "kvStatus", "GET");
  </script>
</body>
</html>