<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>API Endpoint Tester</title>
  <style>
    body { 
      font-family: monospace, 'Courier New', Courier; 
      margin: 2em; 
      background: #121212; 
      color: #eee; 
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    h1, h2 { 
      color: #b388ff; 
      border-bottom: 1px solid #444;
      padding-bottom: 0.5em;
    }
    label { 
      display: block; 
      margin-top: 1em; 
      font-weight: bold; 
      color: #a3d9ff;
    }
    input, textarea, select, button { 
      margin-top: 0.5em; 
      width: 100%; 
      padding: 0.5em; 
      background: #222; 
      color: #fff; 
      border: 1px solid #444; 
      border-radius: 4px;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus, button:focus {
      outline: 2px solid #b388ff;
      border-color: #b388ff;
    }
    button {
      background: #2c2c2c;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #3a3a3a;
    }
    .endpoint { 
      border: 1px solid #444; 
      padding: 1em; 
      margin-bottom: 2em; 
      border-radius: 8px; 
      background: #1e1e1e; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .output { 
      margin-top: 1em; 
      background: #111; 
      color: #a8ffc4; 
      padding: 1em; 
      border-radius: 4px; 
      font-size: 0.95em; 
      white-space: pre-wrap; 
      overflow-x: auto;
      border: 1px solid #333;
    }
    .error { 
      color: #ff557c; 
      font-weight: bold;
    }
    .status { 
      font-weight: bold; 
      margin-left: 1em; 
    }
    .time { 
      color: #888; 
      font-size: 0.9em; 
    }
    .collapsible { 
      cursor: pointer; 
      background: #2c2c2c; 
      color: #b388ff; 
      padding: 0.5em; 
      border: none; 
      text-align: left; 
      outline: none; 
      display: block; 
      width: 100%; 
      margin-top: 1em;
      font-weight: bold;
      border-radius: 4px;
    }
    .collapsible:hover {
      background: #3a3a3a;
    }
    .collapsible:after { 
      content: '\002B'; 
      float: right; 
      font-weight: bold;
    }
    .active:after { 
      content: "\2212"; 
    }
    .content { 
      padding: 0 1em; 
      display: block; 
      max-height: none; 
    }
    .filters { 
      display: flex; 
      gap: 1em; 
      flex-wrap: wrap; 
      margin-top: 1em;
    }
    .filters > * { 
      flex: 1; 
      min-width: 200px; 
    }
    .config-section {
      background: #1a1a1a;
      border: 1px solid #555;
      padding: 1em;
      border-radius: 8px;
      margin-bottom: 2em;
    }
    .config-section h3 {
      margin-top: 0;
      color: #ffcc02;
    }
    .section {
      margin-bottom: 2em;
    }
    .endpoint-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1em;
    }
    .endpoint-item {
      background: #1e1e1e;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 1em;
    }
    .endpoint-item h4 {
      margin-top: 0;
      color: #a3d9ff;
    }
    .form-group {
      margin-bottom: 1em;
    }
    .method-tag {
      background: #4CAF50;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8em;
      margin-left: 0.5em;
    }
    .method-GET { background: #2196F3; }
    .method-POST { background: #4CAF50; }
    .method-PUT { background: #FF9800; }
    .method-DELETE { background: #F44336; }
    .method-OPTIONS { background: #9C27B0; }
    .hidden { display: none; }
    .success { color: #4CAF50; }
    .warning { color: #FF9800; }
    .danger { color: #F44336; }
    code {
      background: #2a2a2a;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: inherit;
      color: #a8ffc4;
    }
    .description {
      color: #aaa;
      font-size: 0.9em;
      margin-top: 0.25em;
    }
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
      }
      .filters > * {
        min-width: 100%;
      }
      body {
        margin: 1em;
      }
    }
  </style>
</head>
<body>
  <h1>üîß API Endpoint Tester</h1>
  <p>Test your API endpoints with a configurable interface. Customize the base URL and endpoints below.</p>

  <!-- Configuration Section -->
  <div class="config-section">
    <h3>‚öôÔ∏è Configuration</h3>
    
    <div class="form-group">
      <label for="baseUrl">Base URL</label>
      <input type="url" id="baseUrl" value="http://localhost:8787" placeholder="https://your-api.example.com" />
      <div class="description">The base URL for all API requests</div>
    </div>

    <div class="form-group">
      <label for="authToken">Authentication Token (Optional)</label>
      <input type="text" id="authToken" placeholder="Bearer eyJhbGciOiJIUzI1NiIs..." />
      <div class="description">Add your auth token if required (e.g., "Bearer token" or "Basic base64")</div>
    </div>

    <div class="form-group">
      <label for="apiConfig">API Configuration</label>
      <textarea id="apiConfig" rows="10" placeholder='[{"path": "/api/test", "method": "GET", "name": "Test Endpoint", "description": "A simple test endpoint"}]'></textarea>
      <div class="description">JSON configuration for custom endpoints. Leave empty to use defaults.</div>
    </div>

    <button onclick="loadConfiguration()">Load Configuration</button>
    <button onclick="resetToDefaults()">Reset to Defaults</button>
    <button onclick="exportConfiguration()">Export Configuration</button>
  </div>

  <!-- Default Endpoints Section -->
  <div class="section">
    <h2>üöÄ Default Endpoints</h2>
    <div class="description">Standard endpoints for the Truth Orchestrator API</div>
    
    <div id="defaultEndpoints">
      <!-- Endpoints will be dynamically generated here -->
    </div>
  </div>

  <!-- Custom Endpoints Section -->
  <div class="section">
    <h2>‚ú® Custom Endpoints</h2>
    <div class="description">Add your own custom endpoints using the configuration above</div>
    
    <div id="customEndpoints">
      <!-- Custom endpoints will be added here -->
    </div>
  </div>

  <script>
    // Default API configuration
    const defaultAPIConfig = [
      {
        path: "/api/truth/resolve",
        method: "POST",
        name: "Resolve Truth",
        description: "Resolve a natural language query",
        fields: [
          { id: "resolveInput", label: "Input", type: "text", placeholder: "How do I debug a JS runtime?", value: "How do I debug a JS runtime?" }
        ]
      },
      {
        path: "/api/truth/master/create",
        method: "POST",
        name: "Create Master",
        description: "Create a new master truth record",
        fields: [
          { id: "masterCreateInput", label: "Input (Query)", type: "text", placeholder: "What is the meaning of life?", value: "What is the meaning of life?" },
          { id: "masterCreateAnswer", label: "Answer", type: "textarea", rows: "2", placeholder: "42 - The universe's secret number.", value: "42 - The universe's secret number." },
          { id: "masterCreateEditor", label: "Editor", type: "text", placeholder: "admin", value: "admin" }
        ]
      },
      {
        path: "/api/truth/master/update",
        method: "POST",
        name: "Update Master",
        description: "Update an existing master truth record",
        fields: [
          { id: "masterUpdateInput", label: "Input (Query/ID)", type: "text", placeholder: "What is the meaning of life?", value: "What is the meaning of life?" },
          { id: "masterUpdateAnswer", label: "Answer", type: "textarea", rows: "2", placeholder: "The answer is actually 42.001 due to cosmic drift.", value: "The answer is actually 42.001 due to cosmic drift." },
          { id: "masterUpdateEditor", label: "Editor", type: "text", placeholder: "admin", value: "admin" },
          { id: "masterUpdateVersion", label: "Expected Version (timestamp or null)", type: "text", placeholder: "Leave empty to ignore", value: "" }
        ]
      },
      {
        path: "/api/truth/master/delete",
        method: "POST",
        name: "Delete Master",
        description: "Delete a master truth record",
        fields: [
          { id: "masterDeleteInput", label: "Input (Query/ID)", type: "text", placeholder: "What is the meaning of life?", value: "What is the meaning of life?" }
        ]
      },
      {
        path: "/api/truth/provisional/update",
        method: "POST",
        name: "Update Provisional",
        description: "Create or update a provisional truth record",
        fields: [
          { id: "provUpdateInput", label: "Input (Query/ID)", type: "text", placeholder: "How do I debug a node app?", value: "How do I debug a node app?" },
          { id: "provUpdateAnswer", label: "Answer", type: "textarea", rows: "2", placeholder: "Use `node --inspect` and Chrome DevTools.", value: "Use `node --inspect` and Chrome DevTools." },
          { id: "provUpdateConfidence", label: "Confidence", type: "number", step: "0.01", placeholder: "0.75", value: "0.75" }
        ]
      },
      {
        path: "/api/truth/provisional/delete",
        method: "POST",
        name: "Delete Provisional",
        description: "Delete a provisional truth record",
        fields: [
          { id: "provDeleteInput", label: "Input (Query/ID)", type: "text", placeholder: "How do I debug a node app?", value: "How do I debug a node app?" }
        ]
      },
      {
        path: "/api/truth/provisional/query",
        method: "POST",
        name: "Query Provisional",
        description: "Search or list provisional truth records",
        fields: [
          { id: "queryMode", label: "Search Mode", type: "select", options: ["id", "prefix", "all"], values: ["by ID", "by Query Prefix", "All (limit 100)"] },
          { id: "querySearchValue", label: "Prefix to search", type: "text", placeholder: "debug, How do I...", value: "debug" },
          { id: "queryMetaSource", label: "Source", type: "text", placeholder: "proxy_ai_candidate", value: "" },
          { id: "queryMetaModel", label: "Model", type: "text", placeholder: "mistral", value: "" },
          { id: "queryMinConfidence", label: "Min Conf (0-0.8)", type: "number", step: "0.01", placeholder: "0.5", value: "" },
          { id: "queryQcPassed", label: "Only QC-passed", type: "checkbox", value: "true" }
        ]
      },
      {
        path: "/api/truth/promote",
        method: "POST",
        name: "Promote to Master",
        description: "Promote a provisional truth to master",
        fields: [
          { id: "promoteInput", label: "Query (ID) to promote", type: "text", placeholder: "How do I debug a node app?", value: "How do I debug a node app?" },
          { id: "promoteEditor", label: "Editor", type: "text", placeholder: "justice", value: "justice" }
        ]
      },
      {
        path: "/debug/kv-status",
        method: "GET",
        name: "KV Status",
        description: "Get key-value store status",
        fields: []
      }
    ];

    // Global variables
    let currentAPIConfig = [...defaultAPIConfig];

    // Utility functions
    function fmtErr(err) {
      return `<span class="error">‚ùå Error: ${err}</span>`;
    }

    function fmtResp({ status, data, duration, url, method }) {
      let out = `[${new Date().toISOString()}] ${method} ${url}\n`;
      const statusColor = status >= 200 && status < 300 ? '#4CAF50' : '#F44336';
      out += `<span class="status" style="color:${statusColor}">${status}</span> `;
      out += `<span class="time">‚è±Ô∏è ${duration?.toFixed(2)}ms</span>\n\n`;
      out += `RESPONSE:\n${JSON.stringify(data, null, 2)}`;
      return out;
    }

    async function apiFetch(path, payload, method = "POST") {
      const base = document.getElementById("baseUrl").value.trim().replace(/\/+$/, "");
      const url = `${base}${path}`;
      const headers = { "Content-Type": "application/json" };
      const auth = document.getElementById("authToken").value.trim();
      if (auth) headers["Authorization"] = auth;

      const start = performance.now();
      try {
        const res = await fetch(url, {
          method,
          headers,
          ...(payload && method !== "GET" ? { body: JSON.stringify(payload) } : {})
        });

        const data = await res.text().catch(() => "");
        let json;
        try { json = JSON.parse(data); } catch { json = { raw: data, parseError: true }; }
        const end = performance.now();
        return { ok: res.ok, data: json, status: res.status, duration: end - start, url, method };
      } catch (err) {
        const end = performance.now();
        return { ok: false, data: { error: err.message }, status: null, duration: end - start, url, method };
      }
    }

    function createEndpointHTML(endpoint, index, isCustom = false) {
      const sectionId = `endpoint-${index}-${isCustom ? 'custom' : 'default'}`;
      const methodClass = `method-${endpoint.method}`;
      
      let html = `
        <button class="collapsible active" onclick="toggleCollapsible(this)">
          <span>${endpoint.method === 'GET' ? 'üîç' : 'üöÄ'} ${endpoint.name}</span>
          <span class="method-tag ${methodClass}">${endpoint.method}</span>
        </button>
        <div class="content endpoint" id="${sectionId}">
          <div class="description">${endpoint.description}</div>
          <div class="path"><code>${endpoint.path}</code></div>
      `;

      // Add form fields
      if (endpoint.fields && endpoint.fields.length > 0) {
        endpoint.fields.forEach(field => {
          html += createFieldHTML(field);
        });
      }

      // Add action buttons
      html += `
          <div style="margin-top: 1em;">
            <button onclick="testEndpoint('${sectionId}', '${endpoint.path}', '${endpoint.method}')">Send Request</button>
            <button onclick="testEndpointOptions('${sectionId}', '${endpoint.path}')" style="margin-left: 0.5em;">Preflight (OPTIONS)</button>
          </div>
          <div class="output" id="${sectionId}-output"></div>
        </div>
      `;

      return html;
    }

    function createFieldHTML(field) {
      let html = `<label for="${field.id}">${field.label}</label>`;
      
      switch (field.type) {
        case 'textarea':
          html += `<textarea id="${field.id}" rows="${field.rows || 3}" placeholder="${field.placeholder || ''}">${field.value || ''}</textarea>`;
          break;
        case 'select':
          html += `<select id="${field.id}">`;
          field.options.forEach((option, index) => {
            const display = field.values ? field.values[index] : option;
            html += `<option value="${option}">${display}</option>`;
          });
          html += `</select>`;
          break;
        case 'checkbox':
          html += `<input type="checkbox" id="${field.id}" ${field.value === 'true' ? 'checked' : ''} />`;
          break;
        default:
          html += `<input type="${field.type || 'text'}" id="${field.id}" placeholder="${field.placeholder || ''}" value="${field.value || ''}" />`;
      }
      
      return html;
    }

    function toggleCollapsible(element) {
      element.classList.toggle("active");
      const content = element.nextElementSibling;
      content.style.display = content.style.display === "none" ? "block" : "none";
    }

    function loadConfiguration() {
      const configText = document.getElementById("apiConfig").value.trim();
      
      if (!configText) {
        alert("Please provide API configuration in JSON format");
        return;
      }

      try {
        const config = JSON.parse(configText);
        currentAPIConfig = [...defaultAPIConfig, ...config];
        renderEndpoints();
        showMessage("Configuration loaded successfully!", "success");
      } catch (error) {
        showMessage(`Error parsing configuration: ${error.message}`, "danger");
      }
    }

    function resetToDefaults() {
      currentAPIConfig = [...defaultAPIConfig];
      document.getElementById("apiConfig").value = '';
      renderEndpoints();
      showMessage("Reset to default configuration", "success");
    }

    function exportConfiguration() {
      const customEndpoints = currentAPIConfig.filter((_, index) => index >= defaultAPIConfig.length);
      const configText = JSON.stringify(customEndpoints, null, 2);
      
      const blob = new Blob([configText], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'api-configuration.json';
      a.click();
      
      URL.revokeObjectURL(url);
      showMessage("Configuration exported successfully!", "success");
    }

    function renderEndpoints() {
      const defaultEndpoints = currentAPIConfig.filter((_, index) => index < defaultAPIConfig.length);
      const customEndpoints = currentAPIConfig.filter((_, index) => index >= defaultAPIConfig.length);

      // Render default endpoints
      document.getElementById("defaultEndpoints").innerHTML = defaultEndpoints
        .map((endpoint, index) => createEndpointHTML(endpoint, index, false))
        .join('');

      // Render custom endpoints
      document.getElementById("customEndpoints").innerHTML = customEndpoints.length > 0 
        ? customEndpoints.map((endpoint, index) => createEndpointHTML(endpoint, index, true)).join('')
        : '<div class="description">No custom endpoints configured. Add them in the Configuration section above.</div>';

      // Initialize collapsible behavior
      document.querySelectorAll('.collapsible').forEach(btn => {
        btn.onclick = function() {
          toggleCollapsible(this);
        };
      });
    }

    async function testEndpoint(sectionId, path, method) {
      const outputId = `${sectionId}-output`;
      const output = document.getElementById(outputId);
      
      output.innerHTML = "üîÑ Loading...";
      
      try {
        let payload = null;
        
        // Collect payload from form fields
        if (method !== "GET") {
          payload = {};
          
          // This is a simplified version - in a real implementation, you'd need to 
          // map field IDs to their values more robustly
          const fields = currentAPIConfig.find(ep => ep.path === path)?.fields || [];
          fields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element) {
              if (field.type === 'checkbox') {
                payload[field.id] = element.checked;
              } else {
                payload[field.id] = element.value;
              }
            }
          });
        }

        const res = await apiFetch(path, payload, method);
        output.innerHTML = fmtResp(res);
        
      } catch (error) {
        output.innerHTML = fmtErr(error.message);
      }
    }

    async function testEndpointOptions(sectionId, path) {
      const outputId = `${sectionId}-output`;
      const output = document.getElementById(outputId);
      
      try {
        const res = await apiFetch(path, null, "OPTIONS");
        output.innerHTML += "\n\n" + fmtResp(res);
      } catch (error) {
        output.innerHTML += "\n\n" + fmtErr(error.message);
      }
    }

    function showMessage(message, type = "info") {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : '#F44336'};
        color: white;
        padding: 1em;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 300px;
      `;
      messageDiv.textContent = message;
      
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        document.body.removeChild(messageDiv);
      }, 3000);
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Set default configuration in the textarea
      document.getElementById("apiConfig").value = '';
      
      // Render endpoints
      renderEndpoints();
      
      // Add event listener for query mode toggle (for the provisional query endpoint)
      const queryModeSelect = document.getElementById("queryMode");
      if (queryModeSelect) {
        queryModeSelect.addEventListener('change', function() {
          const label = document.getElementById("querySearchLabel");
          if (label) {
            const mode = this.value;
            if (mode === "id") label.textContent = "Provisional ID";
            else if (mode === "prefix") label.textContent = "Query Prefix";
            else label.textContent = "Ignored (all)";
          }
        });
      }
    });

    // Make functions global for onclick handlers
    window.toggleCollapsible = toggleCollapsible;
    window.loadConfiguration = loadConfiguration;
    window.resetToDefaults = resetToDefaults;
    window.exportConfiguration = exportConfiguration;
    window.testEndpoint = testEndpoint;
    window.testEndpointOptions = testEndpointOptions;
  </script>
</body>
</html>